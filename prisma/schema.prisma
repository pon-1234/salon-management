generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
}

model Customer {
  id           String        @id @default(cuid())
  name         String
  nameKana     String
  phone        String        @unique
  email        String        @unique
  password     String
  birthDate    DateTime
  memberType   String        @default("regular")
  points       Int           @default(0)
  createdAt    DateTime      @default(now())
  updatedAt        DateTime      @updatedAt
  resetToken           String?
  resetTokenExpiry     DateTime?
  emailVerified        Boolean       @default(false)
  emailVerificationToken String?
  emailVerificationExpiry DateTime?
  ngCasts      NgCastEntry[]
  reservations Reservation[]
  reviews      Review[]
  messages     Message[]
}

model Store {
  id           String              @id
  name         String
  displayName  String
  slug         String              @unique
  phone        String?
  email        String?
  timezone     String              @default("Asia/Tokyo")
  address      String?
  createdAt    DateTime            @default(now())
  updatedAt    DateTime            @updatedAt
  isActive     Boolean             @default(true)
  reservations Reservation[]
  casts        Cast[]
  coursePrices CoursePrice[]
  optionPrices OptionPrice[]
  areaInfos    AreaInfo[]
  stationInfos StationInfo[]
  designationFees DesignationFee[]
  storeSettings StoreSettings?
}

model Cast {
  id                     String         @id @default(cuid())
  name                   String
  age                    Int
  height                 Int
  bust                   String
  waist                  Int
  hip                    Int
  type                   String
  image                  String
  images                 String[]
  description            String
  publicProfile          Json?
  netReservation         Boolean
  specialDesignationFee  Int?
  regularDesignationFee  Int?
  panelDesignationRank   Int
  regularDesignationRank Int
  workStatus             String
  availableOptions       String[]      @default([])
  storeId                String        @default("ikebukuro")
  createdAt              DateTime       @default(now())
  updatedAt              DateTime       @updatedAt
  schedules              CastSchedule[]
  ngByCustomers          NgCastEntry[]
  reservations           Reservation[]
  reviews                Review[]
  messages               Message[]
  store                  Store          @relation(fields: [storeId], references: [id])

  @@index([storeId])
}

model NgCastEntry {
  customerId String
  castId     String
  assignedAt DateTime @default(now())
  cast       Cast     @relation(fields: [castId], references: [id])
  customer   Customer @relation(fields: [customerId], references: [id])

  @@id([customerId, castId])
}

model Reservation {
  id         String              @id @default(cuid())
  customerId String
  castId     String
  courseId   String
  startTime  DateTime
  endTime    DateTime
  status     String
  price      Int                 @default(0)
  storeId    String              @default("ikebukuro")
  designationType   String?
  designationFee    Int          @default(0)
  transportationFee Int          @default(0)
  additionalFee     Int          @default(0)
  paymentMethod     String?      @default("現金")
  marketingChannel  String?
  storeRevenue      Int?
  staffRevenue      Int?
  areaId            String?
  stationId         String?
  locationMemo      String?
  notes             String?
  createdAt  DateTime            @default(now())
  updatedAt  DateTime            @updatedAt
  cast       Cast                @relation(fields: [castId], references: [id])
  course     CoursePrice         @relation(fields: [courseId], references: [id])
  customer   Customer            @relation(fields: [customerId], references: [id])
  area       AreaInfo?           @relation(fields: [areaId], references: [id])
  station    StationInfo?        @relation(fields: [stationId], references: [id])
  options    ReservationOption[]
  histories  ReservationHistory[]
  store      Store               @relation(fields: [storeId], references: [id])

  @@index([storeId])
}

model CoursePrice {
  id           String        @id @default(cuid())
  name         String
  duration     Int
  price        Int
  storeShare   Int?
  castShare    Int?
  description  String
  isActive     Boolean       @default(true)
  archivedAt   DateTime?
  storeId      String        @default("ikebukuro")
  reservations Reservation[]
  store        Store         @relation(fields: [storeId], references: [id])

  @@index([storeId])
}

model OptionPrice {
  id           String              @id @default(cuid())
  name         String
  description  String?
  price        Int
  duration     Int?
  category     String              @default("special")
  displayOrder Int                  @default(0)
  isActive     Boolean              @default(true)
  note         String?
  storeShare   Int?
  castShare    Int?
  createdAt    DateTime             @default(now())
  updatedAt    DateTime             @default(now()) @updatedAt
  archivedAt   DateTime?
  storeId      String              @default("ikebukuro")
  reservations ReservationOption[]
  store        Store               @relation(fields: [storeId], references: [id])

  @@index([storeId])
}

model AreaInfo {
  id           String         @id @default(cuid())
  name         String
  prefecture   String?
  city         String?
  description  String?
  displayOrder Int            @default(0)
  isActive     Boolean        @default(true)
  storeId      String         @default("ikebukuro")
  createdAt    DateTime       @default(now())
  updatedAt    DateTime       @updatedAt
  stations     StationInfo[]
  reservations Reservation[]
  store        Store          @relation(fields: [storeId], references: [id])

  @@index([storeId])
}

model StationInfo {
  id               String    @id @default(cuid())
  name             String
  line             String?
  areaId           String?
  transportationFee Int?     @default(0)
  travelTime       Int?      @default(0) // minutes
  description      String?
  isActive         Boolean   @default(true)
  displayOrder     Int       @default(0)
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt
  area             AreaInfo? @relation(fields: [areaId], references: [id])
  reservations     Reservation[]
  storeId          String    @default("ikebukuro")
  store            Store     @relation(fields: [storeId], references: [id])

  @@index([areaId])
  @@index([storeId])
}

model ReservationOption {
  id            String        @id @default(cuid())
  reservationId String
  optionId      String
  option        OptionPrice   @relation(fields: [optionId], references: [id])
  optionName    String
  optionPrice   Int
  storeShare    Int?
  castShare     Int?
  reservation   Reservation  @relation(fields: [reservationId], references: [id])

  @@unique([reservationId, optionId])
}

model ReservationHistory {
  id               String       @id @default(cuid())
  reservationId    String
  fieldName        String
  fieldDisplayName String
  oldValue         String?
  newValue         String?
  reason           String?
  actorId          String?
  actorName        String?
  actorIp          String?
  actorAgent       String?
  createdAt        DateTime     @default(now())

  reservation Reservation @relation(fields: [reservationId], references: [id], onDelete: Cascade)

  @@index([reservationId])
}

model DesignationFee {
  id          String   @id @default(cuid())
  name        String
  price       Int      @default(0)
  storeShare  Int      @default(0)
  castShare   Int      @default(0)
  description String?
  sortOrder   Int      @default(0)
  isActive    Boolean  @default(true)
  storeId     String   @default("ikebukuro")
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  store       Store    @relation(fields: [storeId], references: [id])

  @@index([storeId])
}

model Review {
  id         String   @id @default(cuid())
  customerId String
  castId     String
  rating     Int
  comment    String
  createdAt  DateTime @default(now())
  cast       Cast     @relation(fields: [castId], references: [id])
  customer   Customer @relation(fields: [customerId], references: [id])
}

model CastSchedule {
  id          String   @id @default(cuid())
  castId      String
  date        DateTime
  startTime   DateTime
  endTime     DateTime
  isAvailable Boolean
  cast        Cast     @relation(fields: [castId], references: [id])

  @@unique([castId, date])
}

model Admin {
  id          String    @id @default(cuid())
  email       String    @unique
  password    String
  name        String
  role        String    @default("staff")
  permissions Json?
  isActive    Boolean   @default(true)
  lastLogin   DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
}

model Message {
  id                String    @id @default(cuid())
  customerId        String?
  castId            String?
  sender            String    // 'customer', 'staff', or 'cast'
  content           String
  timestamp         DateTime
  readStatus        String    @default("未読") // '未読' or '既読'
  isReservationInfo Boolean   @default(false)
  reservationInfo   Json?
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  customer          Customer? @relation(fields: [customerId], references: [id])
  cast              Cast?     @relation(fields: [castId], references: [id])

  @@index([customerId, timestamp])
  @@index([castId, timestamp])
}

model PaymentIntent {
  id                  String              @id @default(cuid())
  stripeIntentId      String              @unique
  amount              Int
  currency            String              @default("jpy")
  status              String              // e.g., 'requires_payment_method', 'succeeded', 'canceled'
  customerId          String?
  metadata            Json?
  providerId          String?             // Provider-specific ID
  provider            String?             // Payment provider name
  paymentMethod       String?             // Payment method type
  errorMessage        String?             // Error message if failed
  createdAt           DateTime            @default(now())
  updatedAt           DateTime            @updatedAt
  paymentTransactions PaymentTransaction[]
}

model PaymentTransaction {
  id              String         @id @default(cuid())
  paymentIntentId String?
  amount          Int
  currency        String         @default("jpy")
  status          String         // e.g., 'pending', 'completed', 'failed', 'refunded'
  type            String         // e.g., 'payment', 'refund'
  provider        String         // e.g., 'stripe', 'cash'
  paymentMethod   String         // e.g., 'card', 'cash'
  customerId      String?
  reservationId   String?
  stripePaymentId String?
  metadata        Json?
  errorMessage    String?
  processedAt     DateTime?
  refundedAt      DateTime?
  refundAmount    Int?
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt
  paymentIntent   PaymentIntent? @relation(fields: [paymentIntentId], references: [id])
}

model StoreSettings {
  id            String   @id @default(cuid())
  storeId       String   @unique @default("ikebukuro")
  storeName     String
  address       String
  phone         String
  email         String
  website       String?
  businessHours String
  description   String
  zipCode       String
  prefecture    String
  city          String
  building      String?
  businessDays  String
  lastOrder     String
  parkingInfo   String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  store         Store    @relation(fields: [storeId], references: [id])

  @@index([storeId])
}

model HotelSettings {
  id           String   @id @default(cuid())
  hotelName    String
  area         String
  roomCount    Int
  hourlyRate   Int
  address      String
  phone        String
  checkInTime  String
  checkOutTime String
  amenities    String[]
  notes        String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
}
